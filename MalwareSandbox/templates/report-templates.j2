<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Relatório de Análise de Arquivos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f7f9fc; }
    .card { border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .badge-high { background: #dc3545; }   /* vermelho */
    .badge-med { background: #fd7e14; }    /* laranja */
    .badge-low { background: #198754; }    /* verde */
    .kv { font-weight: 600; color: #495057; }
    pre { background: #0d1117; color: #c9d1d9; padding: 12px; border-radius: 8px; }
    .table thead th { background: #0d6efd; color: #fff; }
    .small-muted { color:#6c757d; font-size: .9rem }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <header class="mb-4">
      <h1 class="mb-1">Relatório de Análise de Arquivos</h1>
      <div class="small-muted">Gerado em {{ generated_at }}</div>
    </header>

    {% for r in reports %}
    {% set sev = r.severity %}
    {% set sev_class = 'badge-high' if sev == 'ALTA' else ('badge-med' if sev == 'MÉDIA' else 'badge-low') %}
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ r.filename }}</strong>
          <span class="badge {{ sev_class }} ms-2">{{ r.severity }} ({{ r.risk_score }})</span>
        </div>
        <div class="small-muted mono">{{ r.hashes.sha256 }}</div>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <table class="table table-sm">
              <thead>
                <tr><th colspan="2">Resumo</th></tr>
              </thead>
              <tbody>
                <tr><td class="kv">Tamanho</td><td>{{ r.size }} bytes</td></tr>
                <tr><td class="kv">Modificado</td><td>{{ r.modified }}</td></tr>
                <tr><td class="kv">Tipo</td><td>{{ r.type.kind }} <span class="text-muted">({{ r.type.mime }})</span></td></tr>
                <tr><td class="kv">Entropia</td><td>{{ r.entropy }}</td></tr>
              </tbody>
            </table>
          </div>
          <div class="col-md-6">
            <table class="table table-sm">
              <thead>
                <tr><th colspan="2">Hashes</th></tr>
              </thead>
              <tbody class="mono">
                <tr><td class="kv">MD5</td><td>{{ r.hashes.md5 }}</td></tr>
                <tr><td class="kv">SHA1</td><td>{{ r.hashes.sha1 }}</td></tr>
                <tr><td class="kv">SHA256</td><td>{{ r.hashes.sha256 }}</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <table class="table table-sm">
              <thead><tr><th colspan="1">IOCs</th></tr></thead>
              <tbody>
                <tr><td><strong>URLs</strong>: {{ r.iocs.urls|length }}</td></tr>
                <tr><td><strong>IPs</strong>: {{ r.iocs.ips|length }}</td></tr>
                <tr><td><strong>Domínios</strong>: {{ r.iocs.domains|length }}</td></tr>
              </tbody>
            </table>
          </div>
          <div class="col-md-6">
            <table class="table table-sm">
              <thead><tr><th>VirusTotal</th></tr></thead>
              <tbody>
                {% if r.virustotal.found %}
                <tr><td>
                  Malicious: <strong>{{ r.virustotal.malicious }}</strong> •
                  Suspicious: <strong>{{ r.virustotal.suspicious }}</strong> •
                  Undetected: {{ r.virustotal.undetected }} •
                  Harmless: {{ r.virustotal.harmless }} •
                  <a class="ms-1" href="{{ r.virustotal.permalink }}" target="_blank" rel="noopener">Abrir no VT</a>
                </td></tr>
                {% else %}
                <tr><td class="text-muted">Sem dados do VirusTotal ou hash não encontrado.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>

        {% if r.pe %}
        <div class="mt-3">
          <h5 class="mb-2">Detalhes PE</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <table class="table table-sm">
                <thead><tr><th>Seções</th><th>VSz</th><th>RSz</th><th>Entropia</th></tr></thead>
                <tbody class="mono">
                  {% for s in r.pe.sections %}
                  <tr>
                    <td>{{ s.name }}</td>
                    <td>{{ s.virtual_size }}</td>
                    <td>{{ s.raw_size }}</td>
                    <td>{{ s.entropy }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="col-md-6">
              <div class="accordion" id="imp{{ loop.index }}">
                {% for imp in r.pe.imports %}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="heading{{ loop.index }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse{{ loop.index }}" aria-expanded="false"
                            aria-controls="collapse{{ loop.index }}">
                      {{ imp.dll }}
                    </button>
                  </h2>
                  <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#imp{{ loop.index }}">
                    <div class="accordion-body mono" style="max-height:240px;overflow:auto">
                      {{ imp.functions|join(', ') }}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <div class="mt-3">
          <h5 class="mb-2">Strings (preview)</h5>
          <details>
            <summary>Mostrar/ocultar</summary>
            <pre class="mono" style="max-height:300px; overflow:auto">{{ r.strings_preview|join('\n') }}</pre>
          </details>
        </div>

      </div>
      <div class="card-footer text-muted small">
        Tipo: {{ r.type.kind }} • Severidade: {{ r.severity }} • Score: {{ r.risk_score }}
      </div>
    </div>
    {% endfor %}

    <footer class="mt-4 mb-2 small text-muted">
      Uso educacional e em ambientes controlados. Analise somente arquivos com autorização.
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>